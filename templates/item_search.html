{%extends "base.html"%}
{%block content%}
<!-- ã“ã“ã®å†…å´ã«bodyã®ä¸­èº«ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼ï¼ -->
<center>
    <form method="post" action="#" enctype="multipart/form-data">
        <input type="text" id="keyword" name="keyword" placeholder="ä½œå“åã€ã‚­ãƒ£ãƒ©åã€ã‚°ãƒƒã‚ºã®ç¨®é¡ã‚’å…¥åŠ›">

        <button type="button" id="cam">ğŸ“·ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>
        <dialog>
            <video id="camera" autoplay muted></video>
            <input type="button" id="batsu" value="Ã—"><br>
            <button type="button" id="satsuei">æ’®å½±</button>
        </dialog>

        <div class="preview-box" id="dropZone">
            <div id="emptyState">
                <input type="file" id="file" name="file" accept="images/*"><br>
                <img id="img" height="300" style="display: none;"><br><!-- ã“ã“ã«ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãŒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã•ã‚Œã‚‹ -->
                <canvas id="myCanvas" style="display: none;"></canvas><br>
            </div>
        </div>

        <button type="submit" id="kensaku">æ¤œç´¢</button>
    </form>
    <hr>
    <div id="result"></div><!-- ã“ã“ã«æ¤œç´¢çµæœã®ä¸€è¦§ãŒå…¥ã‚‹ -->
</center>

<script>
    var canvas = document.getElementById('myCanvas');
	var video  = document.getElementById('camera');
    var dialog = document.querySelector('dialog');

    $('#cam').text("ğŸ“·ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•");

    //ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ããŸã‹ã®ãƒ•ãƒ©ã‚°
    var localMediaStream = null;
     
    $(document).ready(function() {
        $('#cam').on('click', function(){
            dialog.showModal();

            ///////ä»¥ä¸‹ã€Webã‚«ãƒ¡ãƒ©ã‚’å–ã‚Šæ‰±ã†å‡¦ç†
            video.setAttribute("width", 400);
            video.setAttribute("height", 300);

            //ã‚«ãƒ¡ãƒ©ä½¿ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            var hasGetUserMedia = function() {
                return (navigator.mediaDevices.getUserMedia || navigator.webkitGetUserMedia ||
                        navigator.mozGetUserMedia || navigator.msGetUserMedia);
            };

            //ã‚¨ãƒ©ãƒ¼
            var onFailSoHard = function(e) {
                console.log('ã‚«ãƒ¡ãƒ©ã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“!', e);
                alert("ã‚«ãƒ¡ãƒ©ã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“! " + e);
                dialog.close();
            };

            if(!hasGetUserMedia()) {
                alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã€ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã¯ãŠä½¿ã„ã„ãŸã ã‘ã¾ã›ã‚“ã€‚"); // éå¯¾å¿œã§ã‚ã‚‹ã“ã¨ã‚’é€šçŸ¥
            } else {
                window.URL = window.URL || window.webkitURL;
                navigator.getUserMedia  = navigator.getUserMedia ||
                                navigator.webkitGetUserMedia || navigator.mozGetUserMedia ||
                                navigator.msGetUserMedia;
                navigator.getUserMedia({video: true}, function(stream) {
                        //video.src = window.URL.createObjectURL(stream);//Chromeä»¥å¤–ã®å ´åˆ
                        video.srcObject = stream; //Chromeã®å ´åˆ
                        localMediaStream = stream;
                }, onFailSoHard);
            }
        });
    });

    $('#batsu').on('click', function(){
        if(localMediaStream){
            localMediaStream.getTracks().forEach(function(track){ track.stop(); });
            video.srcObject = null;
        }
        dialog.close();
    });

    const ctx = canvas.getContext("2d");
    var base64Data;
    $('#satsuei').on('click', function(){            
        // canvasã®ã‚µã‚¤ã‚ºè¨­å®š
        canvas.width = video.videoWidth * 0.7;
        canvas.height = video.videoHeight * 0.7;

        // videoã®æ˜ åƒã‚’canvasã«æç”»ã—ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        $('#myCanvas').show();
        $('#file').hide();

        // DBã«ç”»åƒã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹ç”¨ã®å¤‰æ•°
        var imageData = canvas.toDataURL("image/jpeg");
        base64Data = imageData.replace(/^data:image\/png;base64,/, "");

        // // Canvasã®ç”»åƒã‚’ã€Œãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã€ã«å¤‰æ›ã—ã¦ã€imgè¦ç´ ã«å…¥ã‚Œã‚‹
        // canvas.toBlob(function(blob) { // toBlob: Canvasã®çµµã‚’ãƒ‡ãƒ¼ã‚¿(Blob)ã«å¤‰æ›ã™ã‚‹æ©Ÿèƒ½ã€‚
        //     // Blobãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«ã€Œç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚’ç”Ÿæˆ
        //     const date = new Date();
        //     const year = date.getFullYear();
        //     const month = date.getMonth() + 1;
        //     const day = date.getDate();
        //     const time = date.getTime();

        //     const capFile = new File([blob], "./images/captured_" + year + month + day + time + ".jpg", { type: "image/jpeg" });

        //     // ãƒ‡ãƒ¼ã‚¿ã‚’é‹ã¶ãŸã‚ã®ç®±ï¼ˆDataTransferï¼‰ã‚’ä½œã‚‹
        //     const dt = new DataTransfer();
        //     dt.items.add(capFile); // ç®±ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥ã‚Œã‚‹

        //     // imgè¦ç´ ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚»ãƒƒãƒˆ
        //     $('#file').files = dt.files;
        //     console.log("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼", dt.files); // ç¢ºèªç”¨ãƒ­ã‚°
        // }, 'image/jpeg'); // JPEGå½¢å¼ã§ä¿å­˜


        // æ’®å½±ã—ãŸã‚‰è‡ªå‹•ã§é–‰ã˜ã‚‹
        if(localMediaStream){
            localMediaStream.getTracks().forEach(function(track){ track.stop(); });
            video.srcObject = null;
        }
        dialog.close();
        $('#cam').text("æ’®ã‚Šç›´ã™");
    });

    $('#file').on('change', function() { // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        //1. æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
        const input = $('#file').get(0).files[0]; // èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’å¤‰æ•°ã«å…¥ã‚Œã¦ã„ã‚‹ã€‚
        
        //2ï¼ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼šæº–å‚™
        const reader = new FileReader();
        
        //5ï¼ã‚¨ãƒ©ãƒ¼å‡¦ç†
        $(reader).on('error',function () {
            alert("èª­ã¿å–ã‚Šæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        });
        
        //4ï¼ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ãŸã‚‰ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®æ ã«è¡¨ç¤º
        $(reader).on('load', function() {
            $('#file').hide();
            $('#img').show();
            $('#img').attr('src', reader.result);

            // DBã«ç”»åƒã®ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹ç”¨ã®å¤‰æ•°
            var imageData = canvas.toDataURL("image/jpeg");
            base64Data = imageData.replace(/^data:image\/png;base64,/, "");
        });

        //3ï¼ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ï¼ˆä¸­èº«ï¼‰ã‚’ã€DataURLå½¢å¼ï¼ˆç”»åƒã®å½¢å¼ï¼‰ã§å–å¾—ã™ã‚‹ï¼ˆèª­ã¿å–ã‚‹ï¼‰é–¢æ•°ã‚’ä½¿ã†ã€‚
        reader.readAsDataURL(input);
        $('#cam').hide();
    });

    $('#kensaku').on('click', function(){
		var keyword = $('#keyword').val();
        var txt = "ã“ã‚Œã¯æ¨ã—æ´»ã‚°ãƒƒã‚ºã§ã™ã€‚ã“ã®ç”»åƒãŒä½•ã®ã‚°ãƒƒã‚ºãªã®ã‹ã€ä½œå“åã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã€ã‚°ãƒƒã‚ºã®ç¨®é¡ï¼ˆä¾‹ã€ç¼¶ãƒãƒƒã‚¸ãªã©ï¼‰ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚";

        // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
        $.ajax({
            type: 'POST',
            url: 'upload',  // ã‚µãƒ¼ãƒãƒ¼å´ã®url
            data: {
                "imgurl": base64Data, "prompt": encodeURIComponent(txt)
            },
            success: function(response) {
            	//ã“ã“ã«è‡ªåˆ†ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è¨˜è¿°ã™ã‚‹ï¼ï¼
            	//ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®è¿”ç­”ãŒå¤‰æ•°responseã«å…¥ã£ã¦ã„ã‚‹
                $('#result').html(response);
            },
            error: function() {
                alert('å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
    });
</script>

<style>
    dialog {
        border: none;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        padding: 20px;
        text-align: center;
        max-width: 90%;
    }
    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å¾Œã‚ã®èƒŒæ™¯ã‚’æš—ãã™ã‚‹ */
    dialog::backdrop {
        background: rgba(0, 0, 0, 0.6);
    }
    .preview-box {
        border: 2px dashed rgba(0, 0, 0, 0.06);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }
    .preview-box img {
        max-width: 100%;
        border-radius: 6px;
    }
</style>
<!-- ã“ã“ã¾ã§ã§ã™ï¼ï¼ -->
{%endblock%}